<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>å·®ã—è¾¼ã¿å°åˆ·ãƒ„ãƒ¼ãƒ«</title>
</head>
<body style="font-family: 'Helvetica Neue', Arial, sans-serif; color: #333; line-height: 1.6; margin: 0; padding: 20px; background-color: #f9f9f9;">

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div style="max-width: 900px; margin: 0 auto; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px;">
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header style="border-bottom: 2px solid #A47864; padding-bottom: 15px; margin-bottom: 25px;">
      <h1 style="color: #A47864; margin: 0; font-size: 24px;">å·®ã—è¾¼ã¿å°åˆ·ãƒ»PDFä½œæˆãƒ„ãƒ¼ãƒ«</h1>
      <p style="color: #666; margin-top: 5px; font-size: 14px;">Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã€å¸³ç¥¨ã‚’ä¸€æ‹¬ä½œæˆã—ã¾ã™ã€‚</p>
    </header>

    <!-- èª¬æ˜ãƒ»æ³¨æ„ç‚¹ã‚¨ãƒªã‚¢ -->
    <div style="margin-bottom: 35px;">
      <h3 style="margin-top: 0; color: #004d40; font-size: 18px; border-left: 6px solid #A47864; padding-left: 12px; margin-bottom: 15px;">
        ğŸ’¡ ã”åˆ©ç”¨ã®æµã‚Œã¨ãƒ«ãƒ¼ãƒ«
      </h3>
      
      <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæº–å‚™ -->
        <div style="flex: 1; min-width: 280px; background-color: #fdf8f5; border: 1px solid #efebe9; border-radius: 8px; padding: 15px; display: flex; flex-direction: column;">
          <h4 style="margin-top: 0; color: #007a88; font-size: 16px; display: flex; align-items: center;">
            <span style="background: #007a88; color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-block; text-align: center; line-height: 24px; margin-right: 8px; font-size: 14px;">1</span>
            ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)
          </h4>
          <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #5d4037; flex: 1;">
            <li style="margin-bottom: 5px;">å·®ã—è¾¼ã¿é …ç›®ã¯ <code>{{ æ°å }}</code> ã®ã‚ˆã†ã«äºŒé‡ä¸­æ‹¬å¼§ã§å›²ã‚“ã§ãã ã•ã„ã€‚</li>
            <li style="margin-bottom: 5px;">å·®ã—è¾¼ã¿é …ç›®ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®1è¡Œç›®ã®åå‰ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã¦ãã ã•ã„ã€‚</li>
            <li><strong>ä¸€æ‹¬å‡ºåŠ›ã‚’ã™ã‚‹æ™‚ã®æ³¨æ„ç‚¹</strong><br><span style="font-size: 12px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§ã€Œè‡ªå‹•ç•ªå·ãƒªã‚¹ãƒˆã€ã¯ä½¿ã‚ãšã€æ‰‹å…¥åŠ›(ã€Œ1.ã€ãªã©)ã—ã¦ãã ã•ã„ã€‚ãƒšãƒ¼ã‚¸ã‚’ã¾ãŸãã¨ç•ªå·ãŒå´©ã‚Œã¾ã™ã€‚</span></li>
          </ul>
          <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒœã‚¿ãƒ³ -->
          <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #d7ccc8; text-align: center;">
            <a href="https://docs.google.com/document/d/1L15Ptb9kQrfjYQxGcdXDtAAwOXrpzpgQ2eSq4-2eQRQ/edit" target="_blank" style="display: inline-block; background-color: #007a88; color: white; padding: 8px 20px; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: opacity 0.2s;">
              ğŸ“„ ã‚µãƒ³ãƒ—ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¦‹ã‚‹
            </a>
          </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—2ï¼šãƒ‡ãƒ¼ã‚¿æº–å‚™ -->
        <div style="flex: 1; min-width: 280px; background-color: #f4fbf6; border: 1px solid #c8e6c9; border-radius: 8px; padding: 15px; display: flex; flex-direction: column;">
          <h4 style="margin-top: 0; color: #119d48; font-size: 16px; display: flex; align-items: center;">
            <span style="background: #119d48; color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-block; text-align: center; line-height: 24px; margin-right: 8px; font-size: 14px;">2</span>
            ãƒ‡ãƒ¼ã‚¿ (ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ)
          </h4>
          <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #2e7d32; flex: 1;">
            <li style="margin-bottom: 5px;">Aåˆ—ã¯<strong>ã€Œç•ªå·ã€</strong>ãŒå¿…é ˆã§ã™ã€‚<br><span style="font-size: 12px; color: #666;">â€»ãƒ‡ãƒ¼ã‚¿ã®åŒºåˆ‡ã‚Šã«ä½¿ç”¨ã—ã¾ã™ã€‚</span></li>
            <li style="margin-bottom: 5px;">Båˆ—ã¯<strong>ã€Œãƒ•ã‚¡ã‚¤ãƒ«åã€</strong><br><span style="font-size: 12px; color: #666;">â€»å€‹åˆ¥å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã¯å¿…é ˆã§ã™ã€‚<br>â€»å·®ã—è¾¼ã¿é …ç›®å(ä¾‹: <code>è«‹æ±‚æ›¸_{{æ°å}}</code>)ã‚‚ä½¿ç”¨å¯èƒ½ã§ã™ã€‚</span></li>
            <li style="margin-bottom: 5px;">1è¡Œç›®ãŒé …ç›®å(ãƒ˜ãƒƒãƒ€ãƒ¼)ã€2è¡Œç›®ä»¥é™ãŒå·®ã—è¾¼ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã«ãªã‚Šã¾ã™ã€‚</li>
            <li>ç‰¹å®šã®ã‚·ãƒ¼ãƒˆã‚’æŒ‡å®šã—ãŸã„å ´åˆã¯ã€ãã®ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ãŸçŠ¶æ…‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</li>
          </ul>
          <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒœã‚¿ãƒ³ -->
          <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #a5d6a7; text-align: center;">
            <a href="https://docs.google.com/spreadsheets/d/1W_5P5E14b-n5I7iTUooav8WGfbM0DIW2n7pBMxSwDJM/edit" target="_blank" style="display: inline-block; background-color: #119d48; color: white; padding: 8px 20px; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: opacity 0.2s;">
              ğŸ“Š ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹
            </a>
          </div>
        </div>

      </div>

      <!-- å…±é€šã®æ³¨æ„ç‚¹ -->
      <div style="background-color: #fff8e1; border-left: 5px solid #ffecb3; padding: 12px 15px; border-radius: 0 4px 4px 0;">
        <h4 style="margin: 0 0 5px 0; font-size: 14px; color: #ff6f00;">âš ï¸ ãã®ä»–ã®æ³¨æ„ç‚¹</h4>
        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #555;">
          <li>ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã¯ã€ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ç›´ä¸‹ã§ã¯ãªãã€<strong>å¿…ãšä½œæˆã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã®URL</strong>ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</li>
          <li>å‡¦ç†ä¸­ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚</li>
        </ul>
      </div>
    </div>

    <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="inputForm">
      
      <!-- 1. ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š -->
      <section style="margin-bottom: 30px;">
        <h2 style="font-size: 18px; color: #A47864; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
          <span style="background: #A47864; color: white; padding: 2px 8px; border-radius: 4px; font-size: 14px; vertical-align: middle; margin-right: 8px;">STEP 1</span>
          ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®š
        </h2>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ) URL <span style="color:red">*</span></label>
          <input type="text" id="templateUrl" placeholder="https://docs.google.com/document/d/..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; background-color: #fffdf9;">
          <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒœã‚¿ãƒ³ -->
          <div style="text-align: right; margin-top: 6px;">
            <a href="https://docs.google.com/document/d/1L15Ptb9kQrfjYQxGcdXDtAAwOXrpzpgQ2eSq4-2eQRQ/edit" target="_blank" style="display: inline-block; background-color: #007a88; color: white; padding: 6px 15px; border-radius: 3px; text-decoration: none; font-size: 13px; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
              ğŸ“„ ã‚µãƒ³ãƒ—ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¦‹ã‚‹
            </a>
          </div>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ (Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ) URL <span style="color:red">*</span></label>
          <input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; background-color: #f7fcfa;">
          <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒœã‚¿ãƒ³ -->
          <div style="text-align: right; margin-top: 6px;">
            <a href="https://docs.google.com/spreadsheets/d/1W_5P5E14b-n5I7iTUooav8WGfbM0DIW2n7pBMxSwDJM/edit" target="_blank" style="display: inline-block; background-color: #119d48; color: white; padding: 6px 15px; border-radius: 3px; text-decoration: none; font-size: 13px; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
              ğŸ“Š ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹
            </a>
          </div>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ (Googleãƒ‰ãƒ©ã‚¤ãƒ–) URL <span style="color:red">*</span></label>
          <input type="text" id="folderUrl" placeholder="https://drive.google.com/drive/folders/..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
        </div>
      </section>

      <!-- 2. å‡ºåŠ›è¨­å®š (3åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) -->
      <section style="margin-bottom: 30px;">
        <h2 style="font-size: 18px; color: #A47864; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
           <span style="background: #A47864; color: white; padding: 2px 8px; border-radius: 4px; font-size: 14px; vertical-align: middle; margin-right: 8px;">STEP 2</span>
           å‡ºåŠ›è¨­å®š
        </h2>
        
        <!-- 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
        <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: stretch;">
          
          <!-- 1åˆ—ç›®ï¼šå‡ºåŠ›å½¢å¼ -->
          <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #444;">å‡ºåŠ›å½¢å¼</label>
            <div style="background: #f5f5f5; padding: 15px; border-radius: 4px; border: 1px solid #eee; flex: 1;">
              <label style="margin-bottom: 15px; cursor: pointer; display: flex; align-items: flex-start;">
                <input type="radio" name="outputType" value="pdf" checked style="margin-top: 4px; margin-right: 10px;">
                <div>
                  <span style="font-weight: bold; color: #d32f2f; display: block;">PDFå‡ºåŠ›</span>
                  <span style="font-size: 12px; color: #666;">å°åˆ·ã‚„é…å¸ƒã«æœ€é©</span>
                </div>
              </label>
              <label style="cursor: pointer; display: flex; align-items: flex-start;">
                <input type="radio" name="outputType" value="doc" style="margin-top: 4px; margin-right: 10px;">
                <div>
                  <span style="color: #1976d2; font-weight: bold; display: block;">Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</span>
                  <span style="font-size: 12px; color: #666;">å¾Œã§ç·¨é›†ãŒå¯èƒ½</span>
                </div>
              </label>
            </div>
          </div>

          <!-- 2åˆ—ç›®ï¼šç”¨ç´™ã‚µã‚¤ã‚ºãƒ»å‘ã (ç¸¦é…ç½®) -->
          <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 15px;">
            <!-- ç”¨ç´™ã‚µã‚¤ã‚º -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #444;">ç”¨ç´™ã‚µã‚¤ã‚º</label>
              <select id="paperSize" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff;">
                <option value="A4" selected>A4</option>
                <option value="A3">A3</option>
                <option value="A5">A5</option>
                <option value="B4">B4 (JIS)</option>
                <option value="B5">B5 (JIS)</option>
              </select>
            </div>

            <!-- å‘ã -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #444;">å‘ã</label>
              <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; border: 1px solid #eee; display: flex; gap: 15px;">
                <label style="cursor: pointer;">
                  <input type="radio" name="orientation" value="portrait" checked> ç¸¦
                </label>
                <label style="cursor: pointer;">
                  <input type="radio" name="orientation" value="landscape"> æ¨ª
                </label>
              </div>
            </div>
          </div>

          <!-- 3åˆ—ç›®ï¼šå‡ºåŠ›æ–¹æ³• -->
          <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #444;">å‡ºåŠ›æ–¹æ³•</label>
            <div style="background: #f5f5f5; padding: 15px; border-radius: 4px; border: 1px solid #eee; flex: 1;">
              <label style="display: flex; margin-bottom: 15px; cursor: pointer; align-items: flex-start;">
                <input type="radio" name="outputMode" value="individual" checked style="margin-top: 4px; margin-right: 8px;"> 
                <div>
                  <span style="font-weight: bold; display: block;">å€‹åˆ¥ã«å‡ºåŠ›</span>
                  <span style="font-size: 12px; color: #666;">1ä»¶ã«ã¤ã1ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã€‚<br>ãƒ•ã‚¡ã‚¤ãƒ«åæŒ‡å®šå¯ã€‚</span>
                </div>
              </label>
              <label style="display: flex; cursor: pointer; align-items: flex-start;">
                <input type="radio" name="outputMode" value="merged" style="margin-top: 4px; margin-right: 8px;"> 
                <div>
                  <span style="font-weight: bold; display: block;">ä¸€æ‹¬ã§å‡ºåŠ›</span>
                  <span style="font-size: 12px; color: #666;">å…¨ä»¶ã‚’1ãƒ•ã‚¡ã‚¤ãƒ«ã«çµåˆã€‚<br>ä¸€æ‹¬å°åˆ·ã«ä¾¿åˆ©ã€‚</span>
                </div>
              </label>
            </div>
          </div>

        </div>
        <p style="font-size: 12px; color: #888; margin-top: 15px;">â€»æ‹¡å¤§ç¸®å°ã®è¨­å®šã¯ã€å°åˆ·æ™‚ã¾ãŸã¯PDFé–²è¦§æ™‚ã®è¨­å®šã§è¡Œã£ã¦ãã ã•ã„ã€‚</p>
      </section>

      <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="errorArea" style="display: none; background-color: #ffebee; color: #c62828; padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #ef9a9a; border-left: 5px solid #c62828;"></div>

      <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
      <div style="text-align: center; margin-top: 40px;">
        <button id="runBtn" onclick="startProcess()" style="background-color: #A47864; color: white; font-size: 18px; font-weight: bold; padding: 16px 60px; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: all 0.3s; width: 100%; max-width: 400px;">
          ä½œæˆã‚’é–‹å§‹ã™ã‚‹
        </button>
      </div>

    </div>

    <!-- å‡¦ç†ä¸­ãƒ»çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ (åˆæœŸéè¡¨ç¤º) -->
    <div id="processArea" style="display: none; margin-top: 30px;">
      
      <h2 style="font-size: 18px; color: #A47864; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">å‡¦ç†çŠ¶æ³</h2>
      
      <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
      <div style="margin-bottom: 10px; font-weight: bold; color: #555;" id="progressText">æº–å‚™ä¸­...</div>
      <div style="width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 24px; overflow: hidden; margin-bottom: 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
        <div id="progressBar" style="width: 0%; height: 100%; background-color: #A47864; transition: width 0.3s ease; background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 40px 40px;"></div>
      </div>

      <!-- ãƒ­ã‚°è¡¨ç¤º -->
      <div id="statusLog" style="height: 150px; overflow-y: auto; background-color: #2b2b2b; color: #eee; border: 1px solid #444; padding: 15px; font-family: monospace; font-size: 12px; margin-bottom: 25px; border-radius: 4px;">
        <div>å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...</div>
      </div>

      <!-- æˆæœç‰©ãƒªãƒ³ã‚¯ -->
      <div id="resultLinks" style="display: none;">
        <div style="background-color: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 20px;">
          <h3 style="font-size: 16px; color: #119d48; margin-top: 0; display: flex; align-items: center;">
            <span style="margin-right: 8px;">âœ…</span> ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
          </h3>
          <p style="font-size: 12px; color: #555; margin-bottom: 10px;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã™</p>
          <ul id="fileList" style="list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 4px;">
            <!-- ã“ã“ã«ãƒªãƒ³ã‚¯ãŒè¿½åŠ ã•ã‚Œã‚‹ -->
          </ul>
        </div>
      </div>

    </div>

  </div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let g_data = [];
    let g_headers = [];
    let g_ids = {};
    let g_config = {};

    function startProcess() {
      // UIãƒªã‚»ãƒƒãƒˆ
      document.getElementById('errorArea').style.display = 'none';
      document.getElementById('errorArea').innerHTML = '';
      
      // å…¥åŠ›å€¤å–å¾—
      const templateUrl = document.getElementById('templateUrl').value.trim();
      const sheetUrl = document.getElementById('sheetUrl').value.trim();
      const folderUrl = document.getElementById('folderUrl').value.trim();
      
      // å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰å–å¾—
      const outputMode = document.querySelector('input[name="outputMode"]:checked').value;

      if (!templateUrl || !sheetUrl || !folderUrl) {
        showError('ã™ã¹ã¦ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      const btn = document.getElementById('runBtn');
      btn.disabled = true;
      btn.innerHTML = 'æ¤œè¨¼ä¸­... <span style="font-size:12px">(ãŠå¾…ã¡ãã ã•ã„)</span>';
      btn.style.backgroundColor = '#90a4ae';
      btn.style.cursor = 'not-allowed';
      btn.style.boxShadow = 'none';

      // ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œè¨¼ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’å®Ÿè¡Œ
      google.script.run
        .withSuccessHandler(onValidationSuccess)
        .withFailureHandler(onFailure)
        .validateAndFetchData(templateUrl, sheetUrl, folderUrl, outputMode);
    }

    // æ¤œè¨¼æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    function onValidationSuccess(result) {
      if (!result.success) {
        // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼
        let errorHtml = '<strong style="display:block; margin-bottom:5px;">ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„:</strong><ul style="margin:0; padding-left:20px;">';
        result.validationErrors.forEach(e => {
          errorHtml += '<li>' + e + '</li>';
        });
        errorHtml += '</ul>';
        showError(errorHtml, true);
        resetBtn();
        return;
      }

      // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
      g_data = result.data;
      g_headers = result.headers;
      g_ids = result.ids;

      // è¨­å®šå€¤å–å¾—
      g_config = {
        outputType: document.querySelector('input[name="outputType"]:checked').value,
        paperSize: document.getElementById('paperSize').value,
        orientation: document.querySelector('input[name="orientation"]:checked').value,
        outputMode: document.querySelector('input[name="outputMode"]:checked').value
      };

      // UIåˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('inputForm').style.display = 'none';
      document.getElementById('processArea').style.display = 'block';
      document.getElementById('fileList').innerHTML = '';
      document.getElementById('resultLinks').style.display = 'block';

      // å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹åˆ†å²
      if (g_config.outputMode === 'merged') {
        processMerged();
      } else {
        processNext(0);
      }
    }

    // ä¸€æ‹¬çµåˆå‡¦ç†
    function processMerged() {
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
      document.getElementById('progressBar').style.width = '30%';
      document.getElementById('progressText').innerText = 'ä¸€æ‹¬å‡¦ç†ä¸­... (ä»¶æ•°ãŒå¤šã„å ´åˆã€æ•°åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™)';
      addLog('ä¸€æ‹¬çµåˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ...');

      google.script.run
        .withSuccessHandler(function(res) {
          if (res.success) {
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressText').innerText = 'å®Œäº†ã—ã¾ã—ãŸï¼';
            addLog('æˆåŠŸ - ' + res.fileName);
            addLink(res.fileName, res.url);
            addLog('ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
          } else {
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressBar').style.backgroundColor = '#d32f2f';
            document.getElementById('progressText').innerText = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            addLog('ã‚¨ãƒ©ãƒ¼ - ' + res.error);
          }
        })
        .withFailureHandler(function(e) {
          addLog('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ - ' + e.message);
          onFailure(e);
        })
        .generateMergedDocument(g_ids.template, g_ids.folder, g_data, g_headers, g_config);
    }

    // 1ä»¶ãšã¤å‡¦ç†ã™ã‚‹å†å¸°é–¢æ•° (å€‹åˆ¥å‡ºåŠ›ç”¨)
    function processNext(index) {
      const total = g_data.length;
      
      // é€²æ—æ›´æ–°
      const percent = Math.round((index / total) * 100);
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressText').innerText = 'å‡¦ç†ä¸­... ' + (index + 1) + ' / ' + total + ' ä»¶ç›®';

      if (index >= total) {
        // å®Œäº†
        document.getElementById('progressText').innerText = 'å®Œäº†ã—ã¾ã—ãŸï¼';
        document.getElementById('progressBar').style.width = '100%';
        addLog('ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
        return;
      }

      const rowData = g_data[index];

      // ã‚µãƒ¼ãƒãƒ¼å‘¼ã³å‡ºã— (1ä»¶å‡¦ç†)
      google.script.run
        .withSuccessHandler(function(res) {
          if (res.success) {
            addLog((index + 1) + ': æˆåŠŸ - ' + res.fileName);
            addLink(res.fileName, res.url);
          } else {
            addLog((index + 1) + ': ã‚¨ãƒ©ãƒ¼ - ' + res.error);
          }
          // æ¬¡ã¸
          processNext(index + 1);
        })
        .withFailureHandler(function(e) {
          addLog((index + 1) + ': ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ - ' + e.message);
          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æ¬¡ã¸é€²ã‚€
          processNext(index + 1);
        })
        .generateSingleDocument(g_ids.template, g_ids.folder, rowData, g_headers, g_config);
    }

    // ãƒ­ã‚°è¿½åŠ 
    function addLog(msg) {
      const logDiv = document.getElementById('statusLog');
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.style.borderBottom = '1px solid #444';
      div.style.padding = '2px 0';
      div.innerText = '[' + time + '] ' + msg;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // ãƒªãƒ³ã‚¯è¿½åŠ 
    function addLink(name, url) {
      const ul = document.getElementById('fileList');
      const li = document.createElement('li');
      li.style.padding = '10px 15px';
      li.style.borderBottom = '1px solid #eee';
      li.style.display = 'flex';
      li.style.alignItems = 'center';
      
      const icon = document.createElement('span');
      icon.innerText = 'ğŸ“„';
      icon.style.marginRight = '10px';
      icon.style.fontSize = '1.2em';
      
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.innerText = name;
      a.style.color = '#A47864';
      a.style.textDecoration = 'none';
      a.style.fontWeight = 'bold';
      a.style.flex = '1';
      
      // ãƒ›ãƒãƒ¼åŠ¹æœç”¨ï¼ˆCSSãŒä½¿ãˆãªã„ã®ã§JSã§ç°¡æ˜“çš„ã«ï¼‰
      a.onmouseover = function() { this.style.textDecoration = 'underline'; };
      a.onmouseout = function() { this.style.textDecoration = 'none'; };
      
      const btn = document.createElement('a');
      btn.href = url;
      btn.target = '_blank';
      btn.innerText = 'é–‹ã';
      btn.style.backgroundColor = '#A47864';
      btn.style.color = 'white';
      btn.style.padding = '5px 10px';
      btn.style.borderRadius = '3px';
      btn.style.textDecoration = 'none';
      btn.style.fontSize = '12px';
      
      li.appendChild(icon);
      li.appendChild(a);
      li.appendChild(btn);
      ul.appendChild(li);
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(msg, isHtml) {
      const div = document.getElementById('errorArea');
      div.style.display = 'block';
      if (isHtml) {
        div.innerHTML = msg;
      } else {
        div.innerText = msg;
      }
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      div.scrollIntoView({behavior: 'smooth'});
    }

    // å¤±æ•—ãƒãƒ³ãƒ‰ãƒ©
    function onFailure(e) {
      showError('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      resetBtn();
    }

    function resetBtn() {
      const btn = document.getElementById('runBtn');
      btn.disabled = false;
      btn.innerText = 'ä½œæˆã‚’é–‹å§‹ã™ã‚‹';
      btn.style.backgroundColor = '#A47864';
      btn.style.cursor = 'pointer';
      btn.style.boxShadow = '0 4px 6px rgba(0,0,0,0.15)';
    }
  </script>
</body>
</html>
